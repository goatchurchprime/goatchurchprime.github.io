<!DOCTYPE html>

<html>
<head>
<title> MQTT Publish Message</title>
</head>
<style>
p#arrows span { border: thin red solid; padding: 7px }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<script>

// Define some MQTT variables
var client = null; 
var destinationName = "miniwheels1/wheels";
var defaultwebsocketaddr = "test.mosquitto.org:8080"; 

// keys left:37, up:38, right:30, down:40
var keysheld = { 37:0, 38:0, 39:0, 40:0 }
window.onkeydown = function(e) { 
    if ((e.keyCode >= 37) && (e.keyCode <= 40) && !keysheld[e.keyCode]) {
        document.getElementById("key"+e.keyCode).style.background="pink"; 
        keysheld[e.keyCode] = 1; 
        sendcontrol(); 
    }
}
window.onkeyup = function(e) { 
    if ((e.keyCode >= 37) && (e.keyCode <= 40)) {
        document.getElementById("key"+e.keyCode).style.background=""; 
        keysheld[e.keyCode] = 0; 
        sendcontrol(); 
    }
}

function sendcontrol() {
    if (sendcontrolFtimeout !== null) 
        clearTimeout(sendcontrolFtimeout); 
    sendcontrolFtimeout = setTimeout(sendcontrolF, 1); 
}
var sendcontrolFtimeout = null; 
function sendcontrolF() {
    sendcontrolFtimeout = null; 
    
    if (client === null) {
        var websocketaddr = document.getElementById("mqttwebsocket").value.split(":"); 
        client = new Paho.MQTT.Client(websocketaddr[0], parseInt(websocketaddr[1]), "");
        document.getElementById("mqttwebsocket").disabled = true; 
    }
    if (!client.isConnected()) {
        client.connect({onSuccess:sendcontrol});
        return; 
    }

    //left:37, up:38, right:39, down:40
    var leftpwm = 0,   rightpwm = 0; 
    var leftback = 0,  rightback = 0; 
    var leftfore = 0,  rightfore = 0; 
    var timeout = 5000,wtimeout = 10; 
    
    if (keysheld[38]) {
        if (!keysheld[40]) {
            leftpwm = 1023; leftfore = 1;  rightpwm = 1023; rightfore = 1;  wtimeout = 200;  timeout = 250
            if (keysheld[37])
                rightpwm = 800; 
            else if (keysheld[39])
                leftpwm = 800; 
        }
    } else if (keysheld[40]) {
        leftpwm = 800; leftback = 1;  rightpwm = 800; rightback = 1;  wtimeout = 200;  timeout = 250
    } else if (keysheld[37] && !keysheld[39]) {
        leftpwm = 800; leftfore = 1;  rightpwm = 800; rightback = 1;  wtimeout = 50;  timeout = 100
    } else if (!keysheld[37] && keysheld[39]) {
        leftpwm = 800; leftback = 1;  rightpwm = 800; rightfore = 1;  wtimeout = 50;  timeout = 100
    }

    var msg = [rightpwm, rightback, rightfore, leftpwm, leftfore, leftback, wtimeout].join(" "); 
    var message = new Paho.MQTT.Message(msg); 
    message.destinationName = destinationName; 
    client.send(message);
    sendcontrolFtimeout = setTimeout(sendcontrolF, timeout); 
}

window.onload = function() { 
    document.getElementById("mqttwebsocket").value = defaultwebsocketaddr; 
} 

// called when a message arrives
</script>
<body>
<h1>Running the Wheeliepad mini</h1>

MQTT WebSocket: <input type="text" id="mqttwebsocket" value="----"><br><br>

<p><b>Instructions:</b> Click here, and then use your computer cursor keys (up down left right) to steer the robot that is carrying the phone.</p>
<p id="arrows">
    <span id="key37">&lt;&lt;</span> 
    <span id="key38">^^</span> 
    <span id="key40">VV</span> 
    <span id="key39">&gt;&gt;</span>
</p>
</body>
<hr>
<div id=pubmsg></div>
</html>
